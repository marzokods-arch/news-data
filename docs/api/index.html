<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>News Data — Minimal Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px; background: Canvas; color: CanvasText;
    }
    header { margin-bottom: 16px; }
    h1 { font-size: 16px; margin: 0 0 4px 0; font-weight: 600; }
    .muted { opacity: .7; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 16px; }
    .stat { padding:4px 8px; border:1px solid color-mix(in oklab, currentColor 20%, transparent); border-radius:6px; font-size:12px; }
    .controls { margin-bottom: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, select, button { font: inherit; padding: 4px 6px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding: 6px 8px; border-bottom:1px solid color-mix(in oklab, currentColor 15%, transparent); vertical-align: top; }
    th { text-align:left; font-weight:600; }
    td.small { white-space: nowrap; }
    a { color: inherit; text-decoration: underline; text-underline-offset: 2px; }
  </style>
</head>
<body>
  <header>
    <h1>Collected News — Minimal Viewer</h1>
    <div id="refresh" class="muted">Last refresh: —</div>
    <div class="stats" id="stats"></div>
  </header>

  <section class="controls">
    <label>Source:
      <select id="src"></select>
    </label>
    <label>Limit:
      <input id="limit" type="number" min="1" max="4000" value="200" />
    </label>
    <label>Filter:
      <input id="q" type="text" placeholder="title/source/category…" />
    </label>
    <button id="reload">Load</button>
  </section>

  <table>
    <thead>
      <tr>
        <th style="width:42%">Title</th>
        <th>Source</th>
        <th class="small">Category</th>
        <th class="small">Lang</th>
        <th class="small">Time</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
  </table>

<script>
(async function(){
  const $ = (s)=>document.querySelector(s);
  const srcSel = $('#src'), limitInp = $('#limit'), qInp = $('#q');

  async function populateSources() {
    const opts = [ {label:'latest.json (default)', value:'./api/latest.json'} ];
    try {
      const res = await fetch('./api/index.json', {cache:'no-store'});
      if (res.ok) {
        const idx = await res.json();
        (idx.categories||[]).forEach(p=>opts.push({label:p, value:p}));
        (idx.lang||[]).forEach(p=>opts.push({label:p, value:p}));
        (idx.regions||[]).forEach(p=>opts.push({label:p, value:p}));
        (idx.days||[]).forEach(p=>opts.push({label:p, value:p}));
      }
    } catch {}
    srcSel.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  }

  $('#reload').addEventListener('click', ()=>load());

  function fmt(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)?'':d.toISOString().replace('T',' ').replace('Z','Z'); }
  function pill(txt){ const s=document.createElement('span'); s.className='stat'; s.textContent=txt; return s; }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  async function load(){
    const src = srcSel.value || './api/latest.json';
    const limit = Math.max(1, Math.min(4000, Number(limitInp.value)||200));
    const query = (qInp.value||'').toLowerCase().trim();

    $('#rows').innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
    let data;
    try {
      const res = await fetch(src, {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      data = await res.json();
    } catch (e) {
      $('#refresh').textContent = `Load error: ${e.message}`;
      $('#stats').innerHTML = '';
      $('#rows').innerHTML = '<tr><td colspan="5" class="muted">No data.</td></tr>';
      return;
    }

    let items = Array.isArray(data) ? data : (data.items||[]);
    const meta = Array.isArray(data)? null : (data.meta||null);

    $('#stats').innerHTML = '';
    if (meta) {
      $('#refresh').textContent = `Last refresh: ${fmt(meta.generated_at)}`;
      [ pill(`items: ${meta.total||items.length}`),
        pill(`feeds: ${meta.processed_feeds||'-'}`),
        pill(`discovered: ${meta.discovered_feeds||'-'}`),
        meta.shard_of ? pill(`shard ${Number(meta.shard_index)+1} of ${meta.shard_of}`) : null
      ].filter(Boolean).forEach(p=>$('#stats').appendChild(p));
    }

    if (query) {
      items = items.filter(x=>{
        const hay = [x.title||'', x.summary||'', x.category||'', x.lang||'', x.source?.name||''].join(' ').toLowerCase();
        return hay.includes(query);
      });
    }
    items = items.slice(0, limit);

    const rows = items.length ? items.map(x=>`
      <tr>
        <td>
          <a href="${x.link}" target="_blank">${escapeHtml(x.title||'')}</a>
          ${x.summary?`<div class="muted">${escapeHtml(x.summary)}</div>`:''}
        </td>
        <td>${escapeHtml(x.source?.name||'')}</td>
        <td class="small">${escapeHtml(x.category||'')}</td>
        <td class="small">${escapeHtml(x.lang||'')}</td>
        <td class="small">${fmt(x.pubDate||'')}</td>
      </tr>`).join('') : '<tr><td colspan="5" class="muted">No items.</td></tr>';

    $('#rows').innerHTML = rows;
  }

  await populateSources();
  load();
})();
</script>
</body>
</html>
